---
// ReservationModal.astro - äºˆç´„ä¾é ¼ãƒ¢ãƒ¼ãƒ€ãƒ«
export interface Props {
  apiBaseUrl?: string;
}

const { apiBaseUrl = '' } = Astro.props;
---

<div class="reservation-modal-overlay" id="reservationModalOverlay" data-api-base={apiBaseUrl}>
  <div class="reservation-modal" id="reservationModal">
    <div class="modal-header">
      <h2>&#128222; äºˆç´„ä¾é ¼</h2>
      <button class="close-btn" id="closeReservationModal">&times;</button>
    </div>

    <div class="modal-body">
      <!-- åº—èˆ—é¸æŠã‚¨ãƒªã‚¢ -->
      <div class="shop-selection-area">
        <div class="section-header">
          <h3>&#127942; ãŠåº—ã‚’é¸æŠ</h3>
          <p class="selection-guide" id="selectionGuide">å„ªå…ˆé †ã«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼ˆæœ€å¤§3ä»¶ï¼‰</p>
          <button class="reset-btn" id="resetSelection">ã‚„ã‚Šç›´ã—</button>
        </div>
        <div class="shop-list-compact" id="shopListCompact">
          <!-- åº—èˆ—ãƒªã‚¹ãƒˆã¯JSã§å‹•çš„ã«è¿½åŠ  -->
        </div>
        <p class="priority-note">
          &#8505; â‘ â†’â‘¡â†’â‘¢ã®é †ã§é›»è©±ã—ã¾ã™ã€‚äºˆç´„æˆç«‹æ™‚ç‚¹ã§çµ‚äº†ã—ã¾ã™ã€‚
        </p>
      </div>

      <!-- å…±é€šè¨­å®šã‚¨ãƒªã‚¢ -->
      <div class="common-settings" id="commonSettings">
        <h3>&#128203; äºˆç´„å†…å®¹</h3>

        <div class="form-row">
          <label>&#128101; äººæ•°</label>
          <select id="guestCount">
            <option value="1">1å</option>
            <option value="2" selected>2å</option>
            <option value="3">3å</option>
            <option value="4">4å</option>
            <option value="5">5å</option>
            <option value="6">6å</option>
            <option value="7">7å</option>
            <option value="8">8å</option>
            <option value="9">9å</option>
            <option value="10">10åä»¥ä¸Š</option>
          </select>
        </div>

        <div class="form-row">
          <label>&#128197; å¸Œæœ›æ—¥</label>
          <input type="date" id="reservationDate" />
        </div>

        <div class="form-row">
          <label>&#9200; é–‹å§‹æ™‚é–“</label>
          <select id="startTime">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00" selected>18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
            <option value="20:30">20:30</option>
            <option value="21:00">21:00</option>
            <option value="21:30">21:30</option>
          </select>
        </div>

        <div class="form-row time-flexibility">
          <label>&#9201; æ™‚é–“ã®è¨±å®¹ç¯„å›²</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="timeFlexibility" value="exact" checked />
              <span>é–‹å§‹æ™‚é–“å„ªå…ˆ</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="timeFlexibility" value="30" />
              <span>+30åˆ†ã¾ã§</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="timeFlexibility" value="60" />
              <span>+60åˆ†ã¾ã§</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="timeFlexibility" value="90" />
              <span>+90åˆ†ã¾ã§</span>
            </label>
          </div>
        </div>

        <div class="form-row">
          <label>&#129681; å¸­ã®å¸Œæœ›</label>
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" name="seatType" value="table" checked />
              <span>ãƒ†ãƒ¼ãƒ–ãƒ«å¸­</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="seatType" value="counter" />
              <span>ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="seatType" value="private" />
              <span>å€‹å®¤</span>
            </label>
          </div>
        </div>

        <div class="form-row">
          <label>&#128221; ãã®ä»–ã®å¸Œæœ›</label>
          <div class="textarea-with-mic">
            <textarea id="otherRequests" placeholder="èª•ç”Ÿæ—¥ã‚±ãƒ¼ã‚­ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼å¯¾å¿œã€ç¦ç…™å¸­ãªã©"></textarea>
            <button type="button" class="mic-btn" id="otherRequestsMic" title="éŸ³å£°å…¥åŠ›">
              &#127908;
            </button>
          </div>
          <p class="voice-hint" id="voiceHint"></p>
        </div>

        <!-- ãŠåº—æ¯ã«äºˆç´„å†…å®¹ã‚’å¤‰ãˆã‚‹ãƒœã‚¿ãƒ³ -->
        <div class="per-shop-toggle">
          <button type="button" class="per-shop-btn" id="togglePerShopSettings">
            &#9881; ãŠåº—æ¯ã«äºˆç´„å†…å®¹ã‚’å¤‰ãˆã‚‹
          </button>
        </div>
      </div>

      <!-- é¸æŠæ¸ˆã¿åº—èˆ—ã®å€‹åˆ¥è¨­å®š -->
      <div class="selected-shops-detail" id="selectedShopsDetail">
        <!-- é¸æŠã—ãŸåº—èˆ—ã®è©³ç´°è¨­å®šãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
      </div>

      <!-- äºˆç´„è€…æƒ…å ± -->
      <div class="reserver-info">
        <h3>&#128100; äºˆç´„è€…æƒ…å ±</h3>
        <div class="form-row">
          <label>ãŠåå‰</label>
          <input type="text" id="reserverName" value="å±±ç”°å¤ªéƒ" placeholder="äºˆç´„è€…ã®ãŠåå‰" />
        </div>
        <div class="form-row">
          <label>&#128241; æºå¸¯ç•ªå·</label>
          <input type="tel" id="reserverPhone" value="09012345678" placeholder="090xxxxxxxx" />
          <p class="field-hint">â€» åº—èˆ—ã¸ã®é€£çµ¡å…ˆã¨ã—ã¦ä¼ãˆã¾ã™</p>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="cancel-btn" id="cancelReservation">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="submit-btn" id="submitReservation" disabled>
        &#128222; äºˆç´„ä¾é ¼ã‚’é–‹å§‹ã™ã‚‹
      </button>
    </div>
  </div>
</div>

<style>
  .reservation-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .reservation-modal-overlay.active {
    display: flex;
  }

  .reservation-modal {
    background: white;
    border-radius: 20px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
    border-radius: 20px 20px 0 0;
  }

  .modal-header h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 700;
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #6b7280;
    line-height: 1;
    padding: 0;
  }

  .close-btn:hover {
    color: #1f2937;
  }

  .modal-body {
    padding: 24px;
  }

  /* åº—èˆ—é¸æŠã‚¨ãƒªã‚¢ */
  .shop-selection-area {
    margin-bottom: 24px;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }

  .section-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 700;
  }

  .selection-guide {
    margin: 0;
    font-size: 13px;
    color: #6b7280;
    flex: 1;
  }

  .reset-btn {
    background: #f3f4f6;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    color: #6b7280;
  }

  .reset-btn:hover {
    background: #e5e7eb;
    color: #1f2937;
  }

  .shop-list-compact {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .shop-item-compact {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .shop-item-compact.unselected {
    opacity: 0.6;
  }

  .shop-item-compact.selected {
    background: #fef3c7;
    border-color: #f59e0b;
    opacity: 1;
  }

  .shop-item-compact:hover:not(.max-reached) {
    border-color: #f59e0b;
    opacity: 1;
  }

  .shop-item-compact.max-reached:not(.selected) {
    cursor: not-allowed;
    opacity: 0.4;
  }

  :global(.priority-badge) {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #eff6ff !important;
    color: #2563eb !important;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900 !important;
    font-size: 23px;
    flex-shrink: 0;
    border: 2px solid #2563eb !important;
  }

  :global(.priority-badge.empty) {
    background: #f3f4f6 !important;
    color: #9ca3af !important;
    border: 2px solid #d1d5db !important;
    font-weight: normal !important;
  }

  .shop-info-compact {
    flex: 1;
    min-width: 0;
  }

  .shop-name-compact {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .shop-meta-compact {
    font-size: 11px;
    color: #6b7280;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .priority-note {
    margin: 12px 0 0;
    padding: 10px 12px;
    background: #eff6ff;
    border-radius: 8px;
    font-size: 12px;
    color: #1e40af;
  }

  /* å…±é€šè¨­å®šã‚¨ãƒªã‚¢ */
  .common-settings {
    background: #f9fafb;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .common-settings h3 {
    margin: 0 0 16px;
    font-size: 16px;
    font-weight: 700;
  }

  .form-row {
    margin-bottom: 16px;
  }

  .form-row:last-child {
    margin-bottom: 0;
  }

  .form-row label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
    color: #374151;
  }

  .form-row select,
  .form-row input[type="date"],
  .form-row textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    background: white;
  }

  .form-row select:focus,
  .form-row input:focus,
  .form-row textarea:focus {
    outline: none;
    border-color: #f59e0b;
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
  }

  .form-row textarea {
    resize: vertical;
    min-height: 60px;
  }

  .textarea-with-mic {
    display: flex;
    gap: 8px;
    align-items: flex-start;
  }

  .textarea-with-mic textarea {
    flex: 1;
  }

  .mic-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #10b981;
    border: none;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .mic-btn:hover {
    background: #059669;
    transform: scale(1.05);
  }

  .mic-btn.recording {
    background: #ef4444;
    animation: pulse-mic 1.5s infinite;
  }

  @keyframes pulse-mic {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.05); }
  }

  .voice-hint {
    margin: 6px 0 0;
    font-size: 12px;
    color: #6b7280;
    min-height: 18px;
  }

  .voice-hint.recording {
    color: #ef4444;
  }

  .voice-hint.success {
    color: #10b981;
  }

  /* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
  .radio-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .radio-label {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 20px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
  }

  .radio-label:has(input:checked) {
    background: #fef3c7;
    border-color: #f59e0b;
  }

  .radio-label input {
    margin: 0;
  }

  /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚°ãƒ«ãƒ¼ãƒ— */
  .checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 20px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
  }

  .checkbox-label:has(input:checked) {
    background: #fef3c7;
    border-color: #f59e0b;
  }

  .checkbox-label input {
    margin: 0;
  }

  /* ãŠåº—æ¯ã«äºˆç´„å†…å®¹ã‚’å¤‰ãˆã‚‹ãƒœã‚¿ãƒ³ */
  .per-shop-toggle {
    margin-top: 16px;
    text-align: center;
  }

  .per-shop-btn {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    color: #4b5563;
    transition: all 0.2s;
  }

  .per-shop-btn:hover {
    background: #e5e7eb;
    border-color: #9ca3af;
  }

  .per-shop-btn.active {
    background: #dbeafe;
    border-color: #3b82f6;
    color: #1d4ed8;
  }

  /* äºˆç´„è€…æƒ…å ± */
  .reserver-info {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
  }

  .reserver-info h3 {
    margin: 0 0 16px;
    font-size: 16px;
    font-weight: 700;
    color: #92400e;
  }

  .reserver-info input[type="text"],
  .reserver-info input[type="tel"] {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    background: white;
  }

  .reserver-info input:focus {
    outline: none;
    border-color: #f59e0b;
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
  }

  .field-hint {
    margin: 6px 0 0;
    font-size: 11px;
    color: #92400e;
  }

  :global(.field-hint-sm) {
    margin: 4px 0 0;
    font-size: 10px;
    color: #6b7280;
  }

  :global(.shop-phone-row input) {
    background: #fffbeb !important;
    border-color: #fcd34d !important;
  }

  .shop-phone {
    color: #059669;
    font-weight: 500;
  }

  /* é¸æŠæ¸ˆã¿åº—èˆ—è©³ç´° */
  :global(.selected-shops-detail) {
    display: none;
    margin-top: 20px;
  }

  :global(.selected-shops-detail.has-selection) {
    display: block;
  }

  :global(.shop-detail-card) {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
  }

  :global(.shop-detail-header) {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e5e7eb;
  }

  :global(.shop-detail-badge) {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #2563eb;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
  }

  :global(.shop-detail-name) {
    font-weight: 600;
    font-size: 15px;
    flex: 1;
  }

  :global(.shop-detail-form) {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  :global(.shop-detail-form .form-row) {
    margin-bottom: 0;
  }

  :global(.shop-detail-form label) {
    display: block;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #374151;
  }

  :global(.shop-detail-form select),
  :global(.shop-detail-form input[type="date"]),
  :global(.shop-detail-form textarea) {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 13px;
    background: white;
  }

  /* ãŠåº—æ¯è¨­å®š: ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— (ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³) */
  :global(.radio-group-inline) {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  :global(.radio-label-sm) {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 5px 10px;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 16px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
  }

  :global(.radio-label-sm:has(input:checked)) {
    background: #fef3c7;
    border-color: #f59e0b;
  }

  :global(.radio-label-sm input) {
    margin: 0;
    width: 12px;
    height: 12px;
  }

  /* ãŠåº—æ¯è¨­å®š: ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚°ãƒ«ãƒ¼ãƒ— (ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³) */
  :global(.checkbox-group-inline) {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  :global(.checkbox-label-sm) {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 5px 10px;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 16px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
  }

  :global(.checkbox-label-sm:has(input:checked)) {
    background: #fef3c7;
    border-color: #f59e0b;
  }

  :global(.checkbox-label-sm input) {
    margin: 0;
    width: 12px;
    height: 12px;
  }

  /* ãŠåº—æ¯è¨­å®š: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ + ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ (å°) */
  :global(.textarea-with-mic-sm) {
    display: flex;
    gap: 6px;
    align-items: flex-start;
  }

  :global(.textarea-with-mic-sm textarea) {
    flex: 1;
    min-height: 50px;
  }

  :global(.mic-btn-sm) {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #10b981;
    border: none;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  :global(.mic-btn-sm:hover) {
    background: #059669;
    transform: scale(1.05);
  }

  :global(.mic-btn-sm.recording) {
    background: #ef4444;
    animation: pulse-mic 1.5s infinite;
  }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ãƒƒã‚¿ãƒ¼ */
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 24px;
    border-top: 1px solid #e5e7eb;
    position: sticky;
    bottom: 0;
    background: white;
    border-radius: 0 0 20px 20px;
  }

  .cancel-btn {
    padding: 12px 24px;
    background: #f3f4f6;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    color: #6b7280;
  }

  .cancel-btn:hover {
    background: #e5e7eb;
  }

  .submit-btn {
    padding: 12px 24px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    color: white;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    transition: all 0.2s;
  }

  .submit-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
  }

  .submit-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
  @media (max-width: 480px) {
    .reservation-modal {
      max-height: 100vh;
      border-radius: 0;
    }

    .modal-header {
      border-radius: 0;
    }

    .modal-footer {
      border-radius: 0;
    }

    .radio-group,
    .checkbox-group {
      flex-direction: column;
    }

    .radio-label,
    .checkbox-label {
      width: 100%;
    }
  }
</style>

<script>
  interface ShopData {
    name: string;
    category?: string;
    rating?: number;
    location?: string;
    priceRange?: string;
    image?: string;
    phone?: string;      // é›»è©±ç•ªå·ï¼ˆPlaces APIã‹ã‚‰å–å¾—ï¼‰
    place_id?: string;   // Google Place ID
  }

  interface SelectedShop extends ShopData {
    priority: number;
    useCommonSettings: boolean;
    editedPhone?: string;  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç·¨é›†ã—ãŸé›»è©±ç•ªå·
    customSettings?: {
      guestCount?: number;
      date?: string;
      startTime?: string;
      timeFlexibility?: string;
      seatTypes?: string[];
      otherRequests?: string;
    };
  }

  class ReservationModal {
    private overlay: HTMLElement;
    private modal: HTMLElement;
    private shopListContainer: HTMLElement;
    private selectedShopsDetail: HTMLElement;
    private submitBtn: HTMLButtonElement;
    private selectionGuide: HTMLElement;
    private perShopBtn: HTMLButtonElement;

    private shops: ShopData[] = [];
    private selectedShops: SelectedShop[] = [];
    private maxSelection = 3;
    private perShopMode = false;

    constructor() {
      this.overlay = document.getElementById('reservationModalOverlay')!;
      this.modal = document.getElementById('reservationModal')!;
      this.shopListContainer = document.getElementById('shopListCompact')!;
      this.selectedShopsDetail = document.getElementById('selectedShopsDetail')!;
      this.submitBtn = document.getElementById('submitReservation') as HTMLButtonElement;
      this.selectionGuide = document.getElementById('selectionGuide')!;
      this.perShopBtn = document.getElementById('togglePerShopSettings') as HTMLButtonElement;

      this.initEventListeners();
      this.setDefaultDate();
    }

    private initEventListeners() {
      // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
      document.getElementById('closeReservationModal')?.addEventListener('click', () => this.close());
      document.getElementById('cancelReservation')?.addEventListener('click', () => this.close());

      // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      this.overlay.addEventListener('click', (e) => {
        if (e.target === this.overlay) this.close();
      });

      // ã‚„ã‚Šç›´ã—ãƒœã‚¿ãƒ³
      document.getElementById('resetSelection')?.addEventListener('click', () => this.resetSelection());

      // é€ä¿¡ãƒœã‚¿ãƒ³
      this.submitBtn.addEventListener('click', () => this.submitReservation());

      // ESCã‚­ãƒ¼ã§é–‰ã˜ã‚‹
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.overlay.classList.contains('active')) {
          this.close();
        }
      });

      // ãŠåº—æ¯ã«äºˆç´„å†…å®¹ã‚’å¤‰ãˆã‚‹ãƒœã‚¿ãƒ³
      this.perShopBtn?.addEventListener('click', () => this.togglePerShopMode());
    }

    private setDefaultDate() {
      const dateInput = document.getElementById('reservationDate') as HTMLInputElement;
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      dateInput.value = tomorrow.toISOString().split('T')[0];
      dateInput.min = new Date().toISOString().split('T')[0];
    }

    open(shops: ShopData[]) {
      this.shops = shops;
      this.selectedShops = [];
      this.perShopMode = false;
      this.perShopBtn.classList.remove('active');
      this.perShopBtn.innerHTML = '&#9881; ãŠåº—æ¯ã«äºˆç´„å†…å®¹ã‚’å¤‰ãˆã‚‹';
      this.selectedShopsDetail.innerHTML = '';
      this.selectedShopsDetail.classList.remove('has-selection');
      this.renderShopList();
      this.updateSubmitButton();
      this.overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    close() {
      this.overlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    private renderShopList() {
      this.shopListContainer.innerHTML = '';

      this.shops.forEach((shop, index) => {
        const selectedIndex = this.selectedShops.findIndex(s => s.name === shop.name);
        const isSelected = selectedIndex !== -1;
        const priority = isSelected ? selectedIndex + 1 : 0;
        const isMaxReached = this.selectedShops.length >= this.maxSelection && !isSelected;

        const item = document.createElement('div');
        item.className = `shop-item-compact ${isSelected ? 'selected' : 'unselected'} ${isMaxReached ? 'max-reached' : ''}`;
        item.dataset.shopIndex = index.toString();

        item.innerHTML = `
          <div class="priority-badge ${!isSelected ? 'empty' : ''}">
            ${isSelected ? this.getPriorityLabel(priority) : '-'}
          </div>
          <div class="shop-info-compact">
            <div class="shop-name-compact">${shop.name}</div>
            <div class="shop-meta-compact">
              ${shop.rating ? `<span>â­${shop.rating}</span>` : ''}
              ${shop.location ? `<span>${this.truncateLocation(shop.location)}</span>` : ''}
              ${shop.priceRange ? `<span>${shop.priceRange}</span>` : ''}
              ${shop.phone ? `<span class="shop-phone">ğŸ“${shop.phone}</span>` : ''}
            </div>
          </div>
        `;

        item.addEventListener('click', () => this.toggleShopSelection(index));
        this.shopListContainer.appendChild(item);
      });

      this.updateSelectionGuide();
    }

    private getPriorityLabel(priority: number): string {
      // HTMLã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ä¸¸æ•°å­—ã‚’è¡¨ç¤ºï¼ˆå¤ªå­—èµ¤ï¼‰
      const labels = ['', '&#9312;', '&#9313;', '&#9314;'];
      return labels[priority] || priority.toString();
    }

    private truncateLocation(location: string): string {
      if (location.length > 15) {
        return location.substring(0, 15) + '...';
      }
      return location;
    }

    private toggleShopSelection(shopIndex: number) {
      const shop = this.shops[shopIndex];
      const existingIndex = this.selectedShops.findIndex(s => s.name === shop.name);

      if (existingIndex !== -1) {
        // é¸æŠè§£é™¤
        this.selectedShops.splice(existingIndex, 1);
      } else if (this.selectedShops.length < this.maxSelection) {
        // æ–°è¦é¸æŠ
        this.selectedShops.push({
          ...shop,
          priority: this.selectedShops.length + 1,
          useCommonSettings: true
        });
      }

      this.renderShopList();
      this.updateSubmitButton();
      if (this.perShopMode) {
        this.renderPerShopSettings();
      }
    }

    private resetSelection() {
      this.selectedShops = [];
      this.renderShopList();
      this.updateSubmitButton();
      if (this.perShopMode) {
        this.renderPerShopSettings();
      }
    }

    private updateSelectionGuide() {
      const remaining = this.maxSelection - this.selectedShops.length;
      if (this.selectedShops.length === 0) {
        this.selectionGuide.textContent = 'å„ªå…ˆé †ã«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼ˆæœ€å¤§3ä»¶ï¼‰';
      } else if (remaining > 0) {
        this.selectionGuide.textContent = `ã‚ã¨${remaining}ä»¶é¸æŠã§ãã¾ã™`;
      } else {
        this.selectionGuide.textContent = 'é¸æŠå®Œäº†ï¼ˆå¤‰æ›´ã™ã‚‹ã«ã¯åº—èˆ—ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰';
      }
    }

    private updateSubmitButton() {
      this.submitBtn.disabled = this.selectedShops.length === 0;
    }

    private togglePerShopMode() {
      this.perShopMode = !this.perShopMode;
      this.perShopBtn.classList.toggle('active', this.perShopMode);

      if (this.perShopMode) {
        this.perShopBtn.innerHTML = '&#10003; å…±é€šè¨­å®šã«æˆ»ã™';
        this.renderPerShopSettings();
      } else {
        this.perShopBtn.innerHTML = '&#9881; ãŠåº—æ¯ã«äºˆç´„å†…å®¹ã‚’å¤‰ãˆã‚‹';
        this.selectedShopsDetail.innerHTML = '';
        this.selectedShopsDetail.classList.remove('has-selection');
      }
    }

    private renderPerShopSettings() {
      if (this.selectedShops.length === 0) {
        this.selectedShopsDetail.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">å…ˆã«ãŠåº—ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
        this.selectedShopsDetail.classList.add('has-selection');
        return;
      }

      const commonData = this.getFormData();
      const priorityLabels = ['â‘ ', 'â‘¡', 'â‘¢'];
      const apiBase = (document.getElementById('reservationModalOverlay') as HTMLElement)?.dataset.apiBase || '';

      this.selectedShopsDetail.innerHTML = this.selectedShops.map((shop, index) => {
        const settings = shop.customSettings || commonData;
        const seatTypes = settings.seatTypes || [];
        const currentPhone = shop.editedPhone || shop.phone || '';
        return `
          <div class="shop-detail-card" data-shop-index="${index}">
            <div class="shop-detail-header">
              <div class="shop-detail-badge">${priorityLabels[index]}</div>
              <div class="shop-detail-name">${shop.name}</div>
            </div>
            <div class="shop-detail-form">
              <div class="form-row shop-phone-row">
                <label>ğŸ“ é›»è©±ç•ªå·</label>
                <input type="tel" class="shop-phone-input" value="${currentPhone}" placeholder="03-xxxx-xxxx" />
                <p class="field-hint-sm">â€» Places APIã‹ã‚‰å–å¾—ã€‚ä¿®æ­£å¯èƒ½</p>
              </div>
              <div class="form-row">
                <label>ğŸ‘¥ äººæ•°</label>
                <select class="shop-guest-count">
                  ${[1,2,3,4,5,6,7,8,9,10].map(n =>
                    `<option value="${n}" ${settings.guestCount == n ? 'selected' : ''}>${n}${n === 10 ? 'åä»¥ä¸Š' : 'å'}</option>`
                  ).join('')}
                </select>
              </div>
              <div class="form-row">
                <label>ğŸ“… å¸Œæœ›æ—¥</label>
                <input type="date" class="shop-date" value="${settings.date || ''}" />
              </div>
              <div class="form-row">
                <label>â° é–‹å§‹æ™‚é–“</label>
                <select class="shop-start-time">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                  ${['11:00','11:30','12:00','12:30','13:00','13:30','17:00','17:30','18:00','18:30','19:00','19:30','20:00','20:30','21:00','21:30'].map(t =>
                    `<option value="${t}" ${settings.startTime === t ? 'selected' : ''}>${t}</option>`
                  ).join('')}
                </select>
              </div>
              <div class="form-row">
                <label>â± æ™‚é–“ã®è¨±å®¹ç¯„å›²</label>
                <div class="radio-group-inline">
                  <label class="radio-label-sm">
                    <input type="radio" name="timeFlexibility_${index}" value="exact" ${settings.timeFlexibility === 'exact' || !settings.timeFlexibility ? 'checked' : ''} />
                    <span>é–‹å§‹æ™‚é–“å„ªå…ˆ</span>
                  </label>
                  <label class="radio-label-sm">
                    <input type="radio" name="timeFlexibility_${index}" value="30" ${settings.timeFlexibility === '30' ? 'checked' : ''} />
                    <span>+30åˆ†</span>
                  </label>
                  <label class="radio-label-sm">
                    <input type="radio" name="timeFlexibility_${index}" value="60" ${settings.timeFlexibility === '60' ? 'checked' : ''} />
                    <span>+60åˆ†</span>
                  </label>
                  <label class="radio-label-sm">
                    <input type="radio" name="timeFlexibility_${index}" value="90" ${settings.timeFlexibility === '90' ? 'checked' : ''} />
                    <span>+90åˆ†</span>
                  </label>
                </div>
              </div>
              <div class="form-row">
                <label>ğŸª‘ å¸­ã®å¸Œæœ›</label>
                <div class="checkbox-group-inline">
                  <label class="checkbox-label-sm">
                    <input type="checkbox" class="shop-seat-table" value="table" ${seatTypes.includes('table') ? 'checked' : ''} />
                    <span>ãƒ†ãƒ¼ãƒ–ãƒ«å¸­</span>
                  </label>
                  <label class="checkbox-label-sm">
                    <input type="checkbox" class="shop-seat-counter" value="counter" ${seatTypes.includes('counter') ? 'checked' : ''} />
                    <span>ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­</span>
                  </label>
                  <label class="checkbox-label-sm">
                    <input type="checkbox" class="shop-seat-private" value="private" ${seatTypes.includes('private') ? 'checked' : ''} />
                    <span>å€‹å®¤</span>
                  </label>
                </div>
              </div>
              <div class="form-row">
                <label>ğŸ“ ãã®ä»–ã®å¸Œæœ›</label>
                <div class="textarea-with-mic-sm">
                  <textarea class="shop-other-requests" placeholder="ã“ã®ãŠåº—ã¸ã®ç‰¹åˆ¥ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ">${settings.otherRequests || ''}</textarea>
                  <button type="button" class="mic-btn-sm shop-mic-btn" data-shop-index="${index}" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      this.selectedShopsDetail.classList.add('has-selection');

      // å„ãƒ•ã‚©ãƒ¼ãƒ ã®å¤‰æ›´ã‚’ç›£è¦–
      this.selectedShopsDetail.querySelectorAll('.shop-detail-card').forEach((card, index) => {
        const updateCustomSettings = () => {
          const seatTypes: string[] = [];
          if ((card.querySelector('.shop-seat-table') as HTMLInputElement)?.checked) seatTypes.push('table');
          if ((card.querySelector('.shop-seat-counter') as HTMLInputElement)?.checked) seatTypes.push('counter');
          if ((card.querySelector('.shop-seat-private') as HTMLInputElement)?.checked) seatTypes.push('private');

          // é›»è©±ç•ªå·ã®æ›´æ–°
          const phoneInput = card.querySelector('.shop-phone-input') as HTMLInputElement;
          if (phoneInput) {
            this.selectedShops[index].editedPhone = phoneInput.value;
          }

          this.selectedShops[index].useCommonSettings = false;
          this.selectedShops[index].customSettings = {
            guestCount: (card.querySelector('.shop-guest-count') as HTMLSelectElement)?.value,
            date: (card.querySelector('.shop-date') as HTMLInputElement)?.value,
            startTime: (card.querySelector('.shop-start-time') as HTMLSelectElement)?.value,
            timeFlexibility: (card.querySelector(`input[name="timeFlexibility_${index}"]:checked`) as HTMLInputElement)?.value,
            seatTypes: seatTypes,
            otherRequests: (card.querySelector('.shop-other-requests') as HTMLTextAreaElement)?.value
          };
        };
        card.querySelectorAll('select, input, textarea').forEach(el => {
          el.addEventListener('change', updateCustomSettings);
          el.addEventListener('input', updateCustomSettings);
        });

        // éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³
        const micBtn = card.querySelector('.shop-mic-btn') as HTMLButtonElement;
        const textarea = card.querySelector('.shop-other-requests') as HTMLTextAreaElement;
        if (micBtn && textarea) {
          this.setupShopVoiceInput(micBtn, textarea, apiBase);
        }
      });
    }

    private setupShopVoiceInput(micBtn: HTMLButtonElement, textarea: HTMLTextAreaElement, apiBase: string) {
      let isRecording = false;
      let mediaRecorder: MediaRecorder | null = null;

      micBtn.addEventListener('click', async () => {
        if (isRecording) {
          mediaRecorder?.stop();
          isRecording = false;
          micBtn.classList.remove('recording');
          micBtn.textContent = 'ğŸ¤';
          return;
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
          const audioChunks: Blob[] = [];

          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) audioChunks.push(event.data);
          };

          mediaRecorder.onstop = async () => {
            stream.getTracks().forEach(track => track.stop());
            if (audioChunks.length > 0) {
              const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
              const reader = new FileReader();
              reader.readAsDataURL(audioBlob);
              reader.onloadend = async () => {
                const base64Audio = (reader.result as string).split(',')[1];
                try {
                  const response = await fetch(`${apiBase}/api/stt/transcribe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ audio: base64Audio, language_code: 'ja-JP' })
                  });
                  const data = await response.json();
                  if (data.success && data.transcript) {
                    textarea.value = textarea.value ? textarea.value + '\n' + data.transcript : data.transcript;
                    textarea.dispatchEvent(new Event('input'));
                  }
                } catch (e) {
                  console.error('[VoiceInput] Error:', e);
                }
              };
            }
          };

          mediaRecorder.start();
          isRecording = true;
          micBtn.classList.add('recording');
          micBtn.textContent = 'â¹';

          // 5ç§’å¾Œã«è‡ªå‹•åœæ­¢
          setTimeout(() => {
            if (isRecording && mediaRecorder?.state === 'recording') {
              mediaRecorder.stop();
              isRecording = false;
              micBtn.classList.remove('recording');
              micBtn.textContent = 'ğŸ¤';
            }
          }, 5000);

        } catch (error) {
          console.error('[VoiceInput] Mic error:', error);
        }
      });
    }

    private getFormData() {
      return {
        guestCount: (document.getElementById('guestCount') as HTMLSelectElement).value,
        date: (document.getElementById('reservationDate') as HTMLInputElement).value,
        startTime: (document.getElementById('startTime') as HTMLSelectElement).value,
        timeFlexibility: (document.querySelector('input[name="timeFlexibility"]:checked') as HTMLInputElement)?.value,
        seatTypes: Array.from(document.querySelectorAll('input[name="seatType"]:checked'))
          .map(el => (el as HTMLInputElement).value),
        otherRequests: (document.getElementById('otherRequests') as HTMLTextAreaElement).value
      };
    }

    private getReserverInfo() {
      return {
        name: (document.getElementById('reserverName') as HTMLInputElement).value,
        phone: (document.getElementById('reserverPhone') as HTMLInputElement).value
      };
    }

    private submitReservation() {
      const formData = this.getFormData();
      const reserverInfo = this.getReserverInfo();

      // é›»è©±APIç”¨ã®JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å½¢å¼
      const reservationData = {
        // äºˆç´„è€…æƒ…å ±
        reserver: {
          name: reserverInfo.name,
          contact_phone: reserverInfo.phone
        },
        // åº—èˆ—ãƒªã‚¹ãƒˆï¼ˆå„ªå…ˆé †ä½é †ï¼‰
        shops: this.selectedShops.map((shop, index) => {
          const settings = shop.useCommonSettings ? formData : shop.customSettings;
          return {
            name: shop.name,
            phone: shop.editedPhone || shop.phone || '',
            priority: index + 1,
            place_id: shop.place_id || null,
            settings: {
              guests: parseInt(settings?.guestCount || '2'),
              date: settings?.date || '',
              time: settings?.startTime || '',
              flexibility: settings?.timeFlexibility || 'exact',
              seat_types: settings?.seatTypes || [],
              notes: settings?.otherRequests || ''
            }
          };
        }),
        // å…±é€šè¨­å®šï¼ˆå‚è€ƒç”¨ï¼‰
        commonSettings: formData
      };

      console.log('[ReservationModal] äºˆç´„ä¾é ¼JSON:', JSON.stringify(reservationData, null, 2));

      // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      const event = new CustomEvent('reservationSubmit', {
        detail: reservationData
      });
      document.dispatchEvent(event);

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      this.close();

      // TODO: å®Ÿéš›ã®äºˆç´„APIã‚’å‘¼ã³å‡ºã™
      // fetch('/api/reservation/start', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify(reservationData)
      // });

      alert('äºˆç´„ä¾é ¼ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚\n\näºˆç´„è€…: ' + reserverInfo.name + '\né€£çµ¡å…ˆ: ' + reserverInfo.phone +
        '\n\né¸æŠã•ã‚ŒãŸãŠåº—:\n' +
        this.selectedShops.map((s, i) => `${i + 1}. ${s.name} (${s.editedPhone || s.phone || 'é›»è©±ç•ªå·ãªã—'})`).join('\n') +
        '\n\nï¼ˆã“ã®æ©Ÿèƒ½ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ï¼‰');
    }
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
  (window as any).ReservationModal = ReservationModal;

  // éŸ³å£°å…¥åŠ›ã‚¯ãƒ©ã‚¹
  class VoiceInput {
    private micBtn: HTMLButtonElement;
    private textarea: HTMLTextAreaElement;
    private voiceHint: HTMLElement;
    private apiBase: string;

    private isRecording = false;
    private mediaRecorder: MediaRecorder | null = null;
    private audioChunks: Blob[] = [];
    private audioContext: AudioContext | null = null;
    private analyser: AnalyserNode | null = null;
    private silenceTimer: number | null = null;
    private vadCheckInterval: number | null = null;
    private hasSpoken = false;

    private readonly SILENCE_THRESHOLD = 15;
    private readonly SILENCE_DURATION = 3000;

    constructor(micBtnId: string, textareaId: string, voiceHintId: string, apiBase: string) {
      this.micBtn = document.getElementById(micBtnId) as HTMLButtonElement;
      this.textarea = document.getElementById(textareaId) as HTMLTextAreaElement;
      this.voiceHint = document.getElementById(voiceHintId) as HTMLElement;
      this.apiBase = apiBase;

      this.micBtn.addEventListener('click', () => this.toggleRecording());
    }

    private stopVAD() {
      if (this.vadCheckInterval) {
        clearInterval(this.vadCheckInterval);
        this.vadCheckInterval = null;
      }
      if (this.silenceTimer) {
        clearTimeout(this.silenceTimer);
        this.silenceTimer = null;
      }
      if (this.audioContext) {
        this.audioContext.close();
        this.audioContext = null;
      }
      this.analyser = null;
      this.hasSpoken = false;
    }

    private autoStopRecording() {
      console.log('[VoiceInput] ç„¡éŸ³æ¤œå‡º - è‡ªå‹•åœæ­¢');
      this.stopVAD();
      if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
        this.mediaRecorder.stop();
      }
      this.isRecording = false;
      this.micBtn.classList.remove('recording');
      this.micBtn.innerHTML = '&#127908;';
    }

    async toggleRecording() {
      if (this.isRecording) {
        this.stopVAD();
        if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
          this.mediaRecorder.stop();
        }
        this.isRecording = false;
        this.micBtn.classList.remove('recording');
        this.micBtn.innerHTML = '&#127908;';
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        this.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
        this.audioChunks = [];
        this.hasSpoken = false;

        // ç„¡éŸ³æ¤œå‡ºã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        this.audioContext = new AudioContext();
        const source = this.audioContext.createMediaStreamSource(stream);
        this.analyser = this.audioContext.createAnalyser();
        this.analyser.fftSize = 512;
        source.connect(this.analyser);

        const dataArray = new Uint8Array(this.analyser.frequencyBinCount);

        // éŸ³å£°ãƒ¬ãƒ™ãƒ«ã‚’å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯
        this.vadCheckInterval = window.setInterval(() => {
          if (!this.analyser || !this.isRecording) return;

          this.analyser.getByteFrequencyData(dataArray);
          const average = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;

          if (average > this.SILENCE_THRESHOLD) {
            this.hasSpoken = true;
            if (this.silenceTimer) {
              clearTimeout(this.silenceTimer);
              this.silenceTimer = null;
            }
            this.voiceHint.textContent = 'éŒ²éŸ³ä¸­...';
            this.voiceHint.className = 'voice-hint recording';
          } else if (this.hasSpoken && !this.silenceTimer) {
            this.voiceHint.textContent = 'èªè­˜å¾…æ©Ÿä¸­...';
            this.silenceTimer = window.setTimeout(() => {
              this.autoStopRecording();
            }, this.SILENCE_DURATION);
          }
        }, 100);

        this.mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            this.audioChunks.push(event.data);
          }
        };

        this.mediaRecorder.onstop = async () => {
          this.stopVAD();
          stream.getTracks().forEach(track => track.stop());

          if (this.audioChunks.length > 0) {
            const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
            await this.transcribeAudio(audioBlob);
          }
        };

        this.mediaRecorder.start();
        this.isRecording = true;
        this.micBtn.classList.add('recording');
        this.micBtn.innerHTML = '&#9209;';
        this.voiceHint.textContent = 'è©±ã—ã¦ãã ã•ã„...';
        this.voiceHint.className = 'voice-hint recording';

      } catch (error) {
        console.error('[VoiceInput] Error:', error);
        this.voiceHint.textContent = 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼';
        this.voiceHint.className = 'voice-hint';
      }
    }

    private async transcribeAudio(audioBlob: Blob) {
      try {
        this.voiceHint.textContent = 'éŸ³å£°èªè­˜ä¸­...';
        this.voiceHint.className = 'voice-hint';

        const reader = new FileReader();
        reader.readAsDataURL(audioBlob);

        reader.onloadend = async () => {
          const base64Audio = (reader.result as string).split(',')[1];

          const response = await fetch(`${this.apiBase}/api/stt/transcribe`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              audio: base64Audio,
              language_code: 'ja-JP'
            })
          });

          const data = await response.json();

          if (data.success && data.transcript) {
            // æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆã«è¿½è¨˜
            const currentText = this.textarea.value;
            this.textarea.value = currentText
              ? currentText + '\n' + data.transcript
              : data.transcript;
            this.voiceHint.textContent = 'å…¥åŠ›å®Œäº†';
            this.voiceHint.className = 'voice-hint success';
            setTimeout(() => {
              this.voiceHint.textContent = '';
              this.voiceHint.className = 'voice-hint';
            }, 2000);
          } else {
            this.voiceHint.textContent = 'éŸ³å£°ãŒèªè­˜ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
            this.voiceHint.className = 'voice-hint';
          }
        };

      } catch (error) {
        console.error('[VoiceInput] Error:', error);
        this.voiceHint.textContent = 'èªè­˜ã‚¨ãƒ©ãƒ¼';
        this.voiceHint.className = 'voice-hint';
      }
    }
  }

  // åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', () => {
    const modal = new ReservationModal();
    (window as any).reservationModal = modal;

    // APIãƒ™ãƒ¼ã‚¹URLã‚’å–å¾—
    const overlay = document.getElementById('reservationModalOverlay') as HTMLElement;
    const apiBase = overlay?.dataset.apiBase || '';

    // éŸ³å£°å…¥åŠ›ã‚’åˆæœŸåŒ–
    new VoiceInput('otherRequestsMic', 'otherRequests', 'voiceHint', apiBase);

    // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³
    document.addEventListener('openReservationModal', ((event: CustomEvent) => {
      if (event.detail && event.detail.shops) {
        modal.open(event.detail.shops);
      }
    }) as EventListener);
  });
</script>
