---
// ShopCardList.astro - ProposalCard形式のショップカードリスト
export interface Props {
  apiBaseUrl?: string;
}

const { apiBaseUrl = '' } = Astro.props;
---

<div class="shop-list-wrapper" id="shopCardList" data-api-base={apiBaseUrl}>
  
  <div class="shop-list-header">
    <div class="header-icon">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </div>
    <span class="header-title">おすすめの店舗</span>
  </div>

  <div class="shop-card-grid" id="shop-card-grid-content">
  </div>

</div>

<style>
  /* --- 全体のレイアウト --- */
  .shop-list-wrapper {
    display: flex;
    flex-direction: column;
    gap: 16px;
    width: 100%;
    /* 表示アニメーション */
    animation: fadeIn 0.5s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* --- ヘッダー --- */
  .shop-list-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0 8px;
    margin-bottom: 4px;
    color: #374151;
    border-bottom: 2px solid #f3f4f6;
    padding-bottom: 12px;
  }

  .header-icon {
    width: 24px;
    height: 24px;
    color: #ef4444;
  }

  .header-title {
    font-size: 16px;
    font-weight: 700;
  }

  /* --- カードグリッド（中箱） --- */
  .shop-card-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
    min-height: 50px; /* 空になっても潰れないように */
  }

  /* --- カード本体のデザイン --- */
  .shop-list-wrapper :global(.shop-card) {
    background: white;
    border-radius: 24px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .shop-list-wrapper :global(.shop-card:hover) {
    transform: translateY(-4px);
    box-shadow: 0 16px 50px rgba(0, 0, 0, 0.18);
  }

  /* ヒーロー画像リンク */
  .shop-list-wrapper :global(.hero-image-link) {
    display: block;
    text-decoration: none;
    position: relative;
    -webkit-tap-highlight-color: transparent;
  }

  /* ヒーロー画像 */
  .shop-list-wrapper :global(.hero-image) {
    position: relative;
    aspect-ratio: 16/9;
    overflow: hidden;
    min-height: 200px;
  }
  
  @media (max-width: 768px) {
    .shop-list-wrapper :global(.hero-image) {
      min-height: 180px;
    }
    .shop-list-wrapper :global(.hero-image-link) {
      min-height: 180px;
      display: block;
    }
  }

  .shop-list-wrapper :global(.hero-image::after) {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40%;
    background: linear-gradient(to top, rgba(0,0,0,0.4), transparent);
    pointer-events: none;
  }

  .shop-list-wrapper :global(.hero-image img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .shop-list-wrapper :global(.hero-image-link:hover img) {
    transform: scale(1.05);
  }

  /* Google Mapsオーバーレイ */
  .shop-list-wrapper :global(.maps-overlay) {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    color: white;
    gap: 8px;
    z-index: 5;
    pointer-events: none;
  }

  @media (hover: hover) and (pointer: fine) {
    .shop-list-wrapper :global(.hero-image-link:hover .maps-overlay) {
      opacity: 1;
    }
  }
  
  @media (hover: none) {
    .shop-list-wrapper :global(.maps-overlay) {
      opacity: 0.8;
      background: rgba(0, 0, 0, 0.4);
    }
  }

  .shop-list-wrapper :global(.maps-overlay svg) {
    width: 32px;
    height: 32px;
  }

  .shop-list-wrapper :global(.maps-overlay span) {
    font-size: 12px;
    font-weight: 600;
  }

  .shop-list-wrapper :global(.category-badge) {
    position: absolute;
    top: 12px;
    left: 12px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(4px);
    color: #1f2937;
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 11px;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    z-index: 10;
    pointer-events: none;
  }

  .shop-list-wrapper :global(.location-badge) {
    position: absolute;
    bottom: 12px;
    left: 12px;
    right: 12px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 6px 10px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 500;
    color: #1f2937;
    z-index: 10;
    pointer-events: none;
  }

  .shop-list-wrapper :global(.location-badge svg) {
    width: 14px;
    height: 14px;
    color: #ef4444;
    flex-shrink: 0;
  }

  /* カードボディ */
  .shop-list-wrapper :global(.card-body) {
    padding: 16px;
  }

  /* 店名ヘッダーリンク */
  .shop-list-wrapper :global(.shop-header-link) {
    text-decoration: none;
    display: flex;
    gap: 12px;
    align-items: flex-start;
    color: inherit;
    transition: opacity 0.2s;
    margin-bottom: 10px;
  }

  .shop-list-wrapper :global(.shop-header-link:hover) {
    opacity: 0.7;
  }
  
  .shop-list-wrapper :global(.google-map-icon-svg) {
    width: 28px;
    height: 28px;
    flex-shrink: 0;
    margin-top: 2px;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
  }

  .shop-list-wrapper :global(.shop-name) {
    font-size: 18px;
    font-weight: 900;
    color: #1f2937;
    margin: 0 0 6px 0;
    line-height: 1.3;
  }

  .shop-list-wrapper :global(.meta-info) {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 4px;
  }

  .shop-list-wrapper :global(.rating) {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .shop-list-wrapper :global(.stars) {
    display: flex;
  }

  .shop-list-wrapper :global(.star) {
    width: 16px;
    height: 16px;
    color: #d1d5db;
  }

  .shop-list-wrapper :global(.star.filled) {
    color: #fbbf24;
  }

  .shop-list-wrapper :global(.rating-value) {
    font-size: 14px;
    font-weight: 700;
    color: #1f2937;
  }

  .shop-list-wrapper :global(.review-count) {
    font-size: 11px;
    color: #6b7280;
  }

  .shop-list-wrapper :global(.price-range) {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    font-weight: 500;
    color: #4b5563;
    background: #f3f4f6;
    padding: 4px 8px;
    border-radius: 12px;
  }

  .shop-list-wrapper :global(.price-range svg) {
    width: 12px;
    height: 12px;
  }

  /* 説明 */
  .shop-list-wrapper :global(.description) {
    color: #4b5563;
    font-size: 13px;
    line-height: 1.6;
    margin-bottom: 12px;
  }

  /* おすすめポイント */
  .shop-list-wrapper :global(.highlights) {
    background: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 12px;
  }

  .shop-list-wrapper :global(.highlights h4) {
    font-size: 13px;
    font-weight: 700;
    color: #1f2937;
    margin: 0 0 8px 0;
  }

  .shop-list-wrapper :global(.highlights ul) {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .shop-list-wrapper :global(.highlights li) {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 6px;
    font-size: 12px;
    font-weight: 500;
    color: #1f2937;
  }

  .shop-list-wrapper :global(.highlights li:last-child) {
    margin-bottom: 0;
  }

  .shop-list-wrapper :global(.check-icon) {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    background: #10b981;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 1px;
  }

  .shop-list-wrapper :global(.check-icon svg) {
    width: 10px;
    height: 10px;
    color: white;
  }

  /* 来店のポイント */
  .shop-list-wrapper :global(.tips) {
    display: flex;
    gap: 10px;
    background: #eff6ff;
    border-left: 3px solid #3b82f6;
    border-radius: 0 8px 8px 0;
    padding: 10px;
    margin-bottom: 12px;
  }

  .shop-list-wrapper :global(.tips-icon svg) {
    width: 18px;
    height: 18px;
    color: #3b82f6;
    flex-shrink: 0;
  }

  .shop-list-wrapper :global(.tips h5) {
    font-weight: 700;
    color: #1f2937;
    margin: 0 0 2px 0;
    font-size: 12px;
  }

  .shop-list-wrapper :global(.tips p) {
    font-size: 11px;
    color: #4b5563;
    margin: 0;
    line-height: 1.4;
  }

  /* リンクボタン群 */
  .shop-list-wrapper :global(.link-buttons) {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .shop-list-wrapper :global(.link-btn) {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    border-radius: 10px;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .shop-list-wrapper :global(.link-btn:active) {
    transform: scale(0.98);
  }

  /* Instagram */
  .shop-list-wrapper :global(.link-btn.instagram) {
    background: linear-gradient(to right, #ffffff 0%, #ffffff 40%, #f09433 65%, #dc2743 85%, #bc1888 100%);
    color: #1f2937; 
    box-shadow: 0 4px 12px rgba(220, 39, 67, 0.15); 
    border: 1px solid #f3f4f6; 
  }
  
  .shop-list-wrapper :global(.link-btn.instagram:hover) {
    opacity: 0.95;
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(220, 39, 67, 0.25);
  }

  .shop-list-wrapper :global(.link-btn.instagram .link-icon) {
    background: transparent; 
    padding: 2px; 
  }

  .shop-list-wrapper :global(.link-btn.instagram .link-icon img) {
    width: 100%;
    height: 100%;
    object-fit: contain;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); 
  }

  /* ★ホットペッパー (白背景・1px枠線) */
  .shop-list-wrapper :global(.link-btn.hotpepper) {
    background: white; 
    border: 1px solid #ea580c; /* ★1pxに修正 */
    color: #1f2937; 
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.15);
  }

  .shop-list-wrapper :global(.link-btn.hotpepper:hover) {
    background-color: #fff7ed; 
  }

  /* ★ぐるなび (白背景・1px黄色枠線) */
  .shop-list-wrapper :global(.link-btn.gnavi) {
    background: white;
    border: 1px solid #fbbf24; /* ★黄色1px枠線 */
    color: #1f2937;
    box-shadow: 0 4px 12px rgba(251, 191, 36, 0.15);
  }

  .shop-list-wrapper :global(.link-btn.gnavi:hover) {
    background-color: #fffbeb; 
  }

  .shop-list-wrapper :global(.link-btn.maps) {
    background: white;
    border: 2px solid #e5e7eb;
    color: #1f2937;
  }

  .shop-list-wrapper :global(.link-btn.maps:hover) {
    border-color: #fca5a5;
  }

  .shop-list-wrapper :global(.link-btn.tabelog) {
    background: white;
    border: 2px solid #e5e7eb;
    color: #1f2937;
  }

  .shop-list-wrapper :global(.link-btn.tabelog:hover) {
    border-color: #fdba74;
  }

  /* TripAdvisor */
  .shop-list-wrapper :global(.link-btn.tripadvisor) {
    background: #34E0A1; 
    color: #1f2937;
    box-shadow: 0 4px 12px rgba(52, 224, 161, 0.3);
    border: none;
  }
  .shop-list-wrapper :global(.link-btn.tripadvisor:hover) {
    background: #2dd498;
  }

  .shop-list-wrapper :global(.link-btn-content) {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .shop-list-wrapper :global(.link-icon) {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .shop-list-wrapper :global(.link-icon svg) {
    width: 16px;
    height: 16px;
  }

  .shop-list-wrapper :global(.link-btn.hotpepper .link-icon) {
    background: #ea580c; 
    color: white; 
  }

  .shop-list-wrapper :global(.link-btn.gnavi .link-icon) {
    background: #fbbf24;
    color: white;
  }

  .shop-list-wrapper :global(.link-btn.tabelog .link-icon) {
    background: #f97316;
    color: white;
  }

  .shop-list-wrapper :global(.link-btn.tripadvisor .link-icon) {
    background: white; 
    padding: 4px;
    border-radius: 50%;
  }
  .shop-list-wrapper :global(.link-btn.tripadvisor .link-icon img) {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .shop-list-wrapper :global(.link-text) {
    text-align: left;
  }

  .shop-list-wrapper :global(.link-title) {
    font-weight: 700;
    font-size: 12px;
  }

  .shop-list-wrapper :global(.link-subtitle) {
    font-size: 10px;
    opacity: 0.8;
  }

  .shop-list-wrapper :global(.link-arrow) {
    width: 16px;
    height: 16px;
    opacity: 0.6;
  }

  .shop-list-wrapper :global(.tripadvisor-rating) {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 4px;
  }

  .shop-list-wrapper :global(.tripadvisor-rating .circles) {
    display: flex;
    gap: 2px;
  }

  .shop-list-wrapper :global(.tripadvisor-rating .circle) {
    width: 14px;
    height: 14px;
    color: #004F32; 
  }

  .shop-list-wrapper :global(.tripadvisor-rating .circle.filled) {
    color: #004F32;
  }

  .shop-list-wrapper :global(.tripadvisor-rating .circle.empty) {
    color: rgba(0, 79, 50, 0.2);
  }

  .shop-list-wrapper :global(.tripadvisor-rating .circle.half) {
    color: #004F32;
  }

  .shop-list-wrapper :global(.empty-state) {
    text-align: center;
    padding: 40px 20px;
    color: #9ca3af;
    font-size: 13px;
  }
</style>

<script>
  // デバイス判定
  const isMobile = () => {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
    (window.innerWidth <= 768);
  };

  // PC版: ポップアップで開く / モバイル版: 別タブで開く
  window.openLinkPopup = function(event: Event, url: string) {
    if (isMobile()) {
      return true;
    }
    event.preventDefault();
    const width = 900;
    const height = 700;
    const left = (screen.width - width) / 2;
    const top = (screen.height - height) / 2;
    window.open(
      url,
      'shopInfoPopup',
      `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes`
    );
    return false;
  };

  // 食べログGoogle検索の自動処理
  window.handleTabelogSearch = function(event: Event, searchUrl: string) {
    if (isMobile()) {
      return true;
    }
    event.preventDefault();
    const width = 900;
    const height = 700;
    const left = (screen.width - width) / 2;
    const top = (screen.height - height) / 2;
    window.open(
      searchUrl,
      'shopInfoPopup',
      `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes`
    );
    return false;
  };

  interface ShopData {
    name: string;
    category?: string;
    description?: string;
    rating?: number;
    reviewCount?: number;
    priceRange?: string;
    location?: string;
    image?: string;
    highlights?: string[];
    tips?: string;
    hotpepper_url?: string;
    maps_url?: string;
    tabelog_url?: string;
    gnavi_url?: string;
    tripadvisor_url?: string;
    tripadvisor_rating?: number;
    tripadvisor_reviews?: number;
    latitude?: number;
    longitude?: number;
  }

  class ShopCardManager {
    // ★重要: ここには「カード表示領域（中箱）」のIDをセットします
    private containerId: string;
    private currentLanguage: string = 'ja';

    private i18n = {
      ja: {
        instagramTitle: 'Instagram',       
        instagramSubtitle: '最新の投稿を見る',
        tripadvisorTitle: 'TripAdvisor',
        tripadvisorSubtitle: 'レビュー・写真',
        tabelogTitle: '食べログ',
        tabelogSubtitle: '口コミ・写真',
        hotpepperTitle: 'ホットペッパー',
        hotpepperSubtitle: '予約・クーポン',
        gnaviTitle: 'ぐるなび',
        gnaviSubtitle: 'お店情報'
      },
      en: {
        instagramTitle: 'Instagram',       
        instagramSubtitle: 'Latest Photos', 
        tripadvisorTitle: 'TripAdvisor',
        tripadvisorSubtitle: 'Reviews & Photos',
        tabelogTitle: 'Tabelog',
        tabelogSubtitle: 'Reviews & Ratings',
        hotpepperTitle: 'Hotpepper',
        hotpepperSubtitle: 'Reservations & Coupons',
        gnaviTitle: 'Gnavi',
        gnaviSubtitle: 'Restaurant Info'
      },
      zh: {
        instagramTitle: 'Instagram',       
        instagramSubtitle: '查看最新照片',  
        tripadvisorTitle: 'TripAdvisor',
        tripadvisorSubtitle: '评论和照片',
        tabelogTitle: 'Tabelog',
        tabelogSubtitle: '评论和评分',
        hotpepperTitle: 'Hotpepper',
        hotpepperSubtitle: '预订和优惠券',
        gnaviTitle: 'Gnavi',
        gnaviSubtitle: '餐厅信息'
      },
      ko: {
        instagramTitle: 'Instagram',       
        instagramSubtitle: '최신 사진 보기', 
        tripadvisorTitle: 'TripAdvisor',
        tripadvisorSubtitle: '리뷰 및 사진',
        tabelogTitle: 'Tabelog',
        tabelogSubtitle: '리뷰 및 평점',
        hotpepperTitle: 'Hotpepper',
        hotpepperSubtitle: '예약 및 쿠폰',
        gnaviTitle: 'Gnavi',
        gnaviSubtitle: '음식점 정보'
      }
    };

    constructor(containerId: string) {
      this.containerId = containerId;
    }

    private getContainer(): HTMLElement | null {
      return document.getElementById(this.containerId);
    }

    setLanguage(language: string) {
      this.currentLanguage = language;
    }

    private t(key: string): string {
      const langData = this.i18n[this.currentLanguage as keyof typeof this.i18n] ||
      this.i18n.en;
      return langData[key as keyof typeof langData] || key;
    }

    displayShops(shops: ShopData[], language?: string) {
      const container = this.getContainer();
      if (!container) return;

      if (language) {
        this.currentLanguage = language;
      }
      
      // ★クリア: 中箱だけを空にします。外箱（ヘッダー含む）は無事です。
      container.innerHTML = ''; 
      
      if (!shops || shops.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            お店が見つかりませんでした
          </div>
        `;
        return;
      }

      shops.forEach((shop, index) => {
        const card = this.createShopCard(shop);
        container.appendChild(card);
      });
    }

    addShop(shop: ShopData) {
      const container = this.getContainer();
      if (container) {
          const card = this.createShopCard(shop);
          container.appendChild(card);
      }
    }

    private createShopCard(shop: ShopData): HTMLElement {
      const card = document.createElement('div');
      card.className = 'shop-card';

      try {
        const imageUrl = shop.image || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800&h=450&fit=crop';
        const starsHtml = this.createStarsHtml(shop.rating || 0);
        const highlightsHtml = this.createHighlightsHtml(shop.highlights || []);
        const tipsHtml = shop.tips ? this.createTipsHtml(shop.tips) : '';
        const linksHtml = this.createLinksHtml(shop);
        
        let mapsUrl = '#';
        if (shop.maps_url) {
          if (shop.maps_url.includes('place_id:')) {
            const placeIdMatch = shop.maps_url.match(/place_id:(ChIJ[\w-]+)/);
            if (placeIdMatch) {
              const placeId = placeIdMatch[1];
              mapsUrl = `https://www.google.com/maps/search/?api=1&query=Google&query_place_id=${placeId}`;
            } else {
              mapsUrl = shop.maps_url;
            }
          } else {
            mapsUrl = shop.maps_url;
          }
        } else if (shop.latitude && shop.longitude) {
          mapsUrl = `https://www.google.com/maps/search/?api=1&query=${shop.latitude},${shop.longitude}`;
        } else if (shop.name && shop.location) {
          const query = encodeURIComponent(`${shop.name} ${shop.location}`);
          mapsUrl = `https://www.google.com/maps/search/?api=1&query=${query}`;
        } else if (shop.name) {
          const query = encodeURIComponent(shop.name);
          mapsUrl = `https://www.google.com/maps/search/?api=1&query=${query}`;
        }

        const googleMapsIconSvg = `
          <svg class="google-map-icon-svg" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 4C14.0589 4 6 12.0589 6 22C6 33.5 24 44 24 44C24 44 42 33.5 42 22C42 12.0589 33.9411 4 24 4Z" fill="#EA4335"/>
            <path d="M24 44C24 44 42 33.5 42 22C42 17.0294 39.9853 12.5294 36.7279 9.27208L24 22L11.2721 9.27208C8.01472 12.5294 6 17.0294 6 22C6 33.5 24 44 24 44Z" fill="#34A853" fill-opacity="0.2"/>
            <circle cx="24" cy="22" r="10" fill="#1976D2"/>
            <path d="M24 4C14.0589 4 6 12.0589 6 22H24V4Z" fill="#EA4335"/>
            <path d="M24 4V22H42C42 12.0589 33.9411 4 24 4Z" fill="#34A853"/>
            <path d="M24 22V44C24 44 42 33.5 42 22H24Z" fill="#FBBC04"/>
            <path d="M6 22C6 33.5 24 44 24 44V22H6Z" fill="#1976D2"/>
            <circle cx="24" cy="22" r="5" fill="white"/>
          </svg>
        `;

        card.innerHTML = `
          <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" class="hero-image-link" data-maps-url="${mapsUrl}">
            <div class="hero-image">
              <img src="${imageUrl}" alt="${shop.name}" loading="lazy" />
              ${shop.category ? `<span class="category-badge">${shop.category}</span>` : ''}
              ${shop.location ? `
                <div class="location-badge">
                  <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                  </svg>
                  <span>${shop.location}</span>
                </div>
              ` : ''}
            </div>
          </a>
          <div class="card-body">
            <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" class="shop-header-link">
              ${googleMapsIconSvg}
              <div class="shop-header-content">
                <h3 class="shop-name">${shop.name}</h3>
                <div class="meta-info">
                  ${shop.rating ? `
                    <div class="rating">
                      <div class="stars">${starsHtml}</div>
                      <span class="rating-value">${shop.rating}</span>
                      ${shop.reviewCount ? `<span class="review-count">(${shop.reviewCount}件)</span>` : ''}
                    </div>
                  ` : ''}
                  ${shop.priceRange ? `
                    <div class="price-range">
                      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                      <span>${shop.priceRange}</span>
                    </div>
                  ` : ''}
                </div>
              </div>
            </a>
            ${shop.description ? `<p class="description">${shop.description}</p>` : ''}
            ${highlightsHtml}
            ${tipsHtml}
            <div class="link-buttons">
              ${linksHtml}
            </div>
          </div>
        `;
      } catch (e) {
        console.error('ShopCard creation failed:', e, shop);
        card.innerHTML = `<div style="padding:20px; color:red;">カード生成エラー: ${shop.name}</div>`;
      }

      return card;
    }

    private createStarsHtml(rating: number): string {
      let html = '';
      for (let i = 0; i < 5; i++) {
        const filled = i < Math.floor(rating) ? 'filled' : '';
        html += `
          <svg class="star ${filled}" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
          </svg>
        `;
      }
      return html;
    }

    private createCirclesHtml(rating: number): string {
      let html = '';
      const fullCircles = Math.floor(rating);
      const hasHalfCircle = rating % 1 >= 0.5;
      for (let i = 0; i < 5; i++) {
        if (i < fullCircles) {
          html += `<svg class="circle filled" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>`;
        } else if (i === fullCircles && hasHalfCircle) {
          html += `
            <svg class="circle half" viewBox="0 0 24 24">
              <defs>
                <linearGradient id="half-${i}">
                  <stop offset="50%" stop-color="currentColor"/>
                  <stop offset="50%" stop-color="transparent"/>
                </linearGradient>
              </defs>
              <circle cx="12" cy="12" r="10" fill="url(#half-${i})" stroke="currentColor" stroke-width="1.5"/>
            </svg>
          `;
        } else {
          html += `<svg class="circle empty" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="1.5"/></svg>`;
        }
      }
      return html;
    }

    private createHighlightsHtml(highlights: string[]): string {
      if (highlights.length === 0) return '';
      const listItems = highlights.map(h => `
        <li>
          <span class="check-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg></span>
          <span>${h}</span>
        </li>
      `).join('');
      return `<div class="highlights"><h4>✨ おすすめポイント</h4><ul>${listItems}</ul></div>`;
    }

    private createTipsHtml(tips: string): string {
      return `
        <div class="tips">
          <div class="tips-icon">
            <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>
          </div>
          <div><h5>来店のポイント</h5><p>${tips}</p></div>
        </div>
      `;
    }

    private createLinksHtml(shop: ShopData): string {
      const links: string[] = [];
      
      if (shop.name) {
        const tagName = shop.name.replace(/\s+/g, '');
        const instaUrl = `https://www.instagram.com/explore/tags/${encodeURIComponent(tagName)}/`;
        links.push(`
          <a href="${instaUrl}" target="_blank" rel="noopener noreferrer" class="link-btn instagram" onclick="return openLinkPopup(event, '${instaUrl}')">
            <div class="link-btn-content">
              <div class="link-icon"><img src="/instagram-logo.png" alt="Instagram" loading="lazy" /></div>
              <div class="link-text"><div class="link-title">${this.t('instagramTitle')}</div><div class="link-subtitle">${this.t('instagramSubtitle')}</div></div>
            </div>
            <svg class="link-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
          </a>
        `);
      }

      if (shop.tripadvisor_url) {
        const escapedUrl = shop.tripadvisor_url.replace(/'/g, "\\'");
        const circlesHtml = shop.tripadvisor_rating ? this.createCirclesHtml(shop.tripadvisor_rating) : '';
        const ratingValue = shop.tripadvisor_rating ? shop.tripadvisor_rating.toFixed(1) : '';
        const reviewCount = shop.tripadvisor_reviews || 0;

        links.push(`
          <a href="${shop.tripadvisor_url}" target="_blank" rel="noopener noreferrer" class="link-btn tripadvisor" onclick="return openLinkPopup(event, '${escapedUrl}')">
            <div class="link-btn-content">
              <div class="link-icon"><img src="/TripAdvisor-logo.png" alt="TripAdvisor" loading="lazy" /></div>
              <div class="link-text">
                <div class="link-title">${this.t('tripadvisorTitle')}</div>
                ${circlesHtml ? `<div class="tripadvisor-rating"><div class="circles">${circlesHtml}</div><span class="rating-score">${ratingValue}</span><span class="review-count">(${reviewCount})</span></div>` : `<div class="link-subtitle">${this.t('tripadvisorSubtitle')}</div>`}
              </div>
            </div>
            <svg class="link-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
          </a>
        `);
      }

      if (shop.tabelog_url) {
        const escapedUrl = shop.tabelog_url.replace(/'/g, "\\'");
        const isGoogleSearch = shop.tabelog_url.includes('google.com/search');
        const onclickAttr = isGoogleSearch ? `onclick="return handleTabelogSearch(event, '${escapedUrl}')"` : `onclick="return openLinkPopup(event, '${escapedUrl}')"`;
        links.push(`
          <a href="${shop.tabelog_url}" target="_blank" rel="noopener noreferrer" class="link-btn tabelog" ${onclickAttr}>
            <div class="link-btn-content">
              <div class="link-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2V6h2V4h-4zm4 0v8h2V6h2V4h-4z"/></svg></div>
              <div class="link-text"><div class="link-title">${this.t('tabelogTitle')}</div><div class="link-subtitle">${this.t('tabelogSubtitle')}</div></div>
            </div>
            <svg class="link-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
          </a>
        `);
      }

      if (shop.hotpepper_url) {
        const escapedUrl = shop.hotpepper_url.replace(/'/g, "\\'");
        links.push(`
          <a href="${shop.hotpepper_url}" target="_blank" rel="noopener noreferrer" class="link-btn hotpepper" onclick="return openLinkPopup(event, '${escapedUrl}')">
            <div class="link-btn-content">
              <div class="link-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/></svg></div>
              <div class="link-text"><div class="link-title">${this.t('hotpepperTitle')}</div><div class="link-subtitle">${this.t('hotpepperSubtitle')}</div></div>
            </div>
            <svg class="link-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
          </a>
        `);
      }

      if (shop.gnavi_url) {
        const escapedUrl = shop.gnavi_url.replace(/'/g, "\\'");
        links.push(`
          <a href="${shop.gnavi_url}" target="_blank" rel="noopener noreferrer" class="link-btn gnavi" onclick="return openLinkPopup(event, '${escapedUrl}')">
            <div class="link-btn-content">
              <div class="link-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></div>
              <div class="link-text"><div class="link-title">${this.t('gnaviTitle')}</div><div class="link-subtitle">${this.t('gnaviSubtitle')}</div></div>
            </div>
            <svg class="link-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
          </a>
        `);
      }

      return links.join('');
    }

    clear() {
      const container = this.getContainer();
      if (container) {
          container.innerHTML = '';
      }
    }
  }

  // グローバルに公開
  (window as any).ShopCardManager = ShopCardManager;
  // 初期化
  document.addEventListener('DOMContentLoaded', () => {
    // ★重要: "shop-card-grid-content"（中箱のID）をマネージャーに渡します
    const manager = new ShopCardManager('shop-card-grid-content');
    (window as any).shopCardManager = manager;

    document.addEventListener('displayShops', ((event: CustomEvent) => {
      if (event.detail && event.detail.shops) {
        const language = event.detail.language || 'ja';
        manager.displayShops(event.detail.shops, language);
      }
    }) as EventListener);
  });
</script>
